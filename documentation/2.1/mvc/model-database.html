<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="../../../media/images/favicon.ico" />

    <title>Model and Database | Windwalker - PHP Rapid Development Framework</title>

    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
    <link rel="stylesheet" href="../../../media/css/bootstrap.css" />
    <link rel="stylesheet" href="../../../media/css/bootstrap-material-design.css" />
    <link rel="stylesheet" href="../../../media/css/ripples.css" />
    <link rel="stylesheet" href="../../../media/css/main.css" />
    <link rel="stylesheet" href="../../../media/css/prism.css" />

    <meta name="description" content="">
    <meta name="generator" content="The Time Machine">

    <meta property="og:title" content="Model and Database | Windwalker - PHP Rapid Development Framework">
    <meta property="og:site_name" content="Windwalker Framework">

    
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../../../media/js/jquery.js"></script>
    <script src="../../../media/js/jquery.smooth-scroll.js"></script>
    <script src="../../../media/js/bootstrap.js"></script>
    <script src="../../../media/js/material.js"></script>
    <script src="../../../media/js/ripples.js"></script>
    <script src="../../../media/js/prism.js"></script>
    <script>
        $(document).ready(function() {

            // Init Material
            $.material.init();

            // Code Block
            $('.article-content pre code').each(function(i, block) {
                var $this = $(this);

                $this.attr('class', 'language-' + $this.attr('class'));
            });

            // Smooth scroll
            setTimeout(function ()
            {
                $('body a').smoothScroll({
                    afterScroll:function (event) {
                        document.location.hash = this.hash
                    }
                });
            }, 500);

            // Table style
            // Convert table style
            var tables = $('.article-content table');

            tables.addClass('table').addClass('table-striped');

            // Navbar
            var navTop;
            var hasColor = false;
            var nav = $('#nav .navbar');

            processScrollInit();
            processScroll();

            $(window).on('resize', processScrollInit);
            $(window).on('scroll', processScroll);

            function processScrollInit()
            {
                if (nav.length) {
                    navTop = nav.length && 60;

                    // Only apply the scrollspy when the toolbar is not collapsed
                    if (document.body.clientWidth > 480)
                    {
//                        $('.subhead-collapse').height(nav.height());
                        nav.scrollspy({offset: {top: nav.offset().top}});
                    }
                }
            }

            function processScroll()
            {
                if (nav.length) {
                    var scrollTop = $(window).scrollTop();

                    if (scrollTop >= navTop && !hasColor) {
                        hasColor = true;
                        nav.addClass('navbar-primary');
                    } else if (scrollTop <= navTop && hasColor) {
                        hasColor = false;
                        nav.removeClass('navbar-primary');
                    }
                }
            }
        });

    </script>

        <script src="../../../media/js/doc.js"></script>
</head>
<body class="">

    <section id="header">

            <nav id="nav">

    <div class="navbar navbar-transparent">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="../../../">
                    <img class="img-invert" src="../../../media/images/logo/windwalker-logo.png" alt="Logo" style="max-height: 100%">
                </a>
            </div>
            <div class="navbar-collapse collapse navbar-responsive-collapse">
                                                                                                                                                                                                                                                                                

                <ul class="mainmenu nav navbar-nav navbar-right">
                    <li class="">
                        <a href="../../../about/">
                            <i class="material-icons">change_history</i>
                            <span class="menu-item-title">About</span>
                        </a>
                    </li>

                    <li class="active">
                        <a href="../../../documentation/3.x/start/installation.html">
                            <i class="material-icons">description</i>
                            <span class="menu-item-title">Documentation</span>
                        </a>
                    </li>

                    <li class="">
                        <a href="../../../rad/start/introduction.html">
                            <i class="material-icons">graphic_eq</i>
                            <span class="menu-item-title">RAD</span>
                        </a>
                    </li>

                    <li class="">
                        <a href="https://github.com/ventoviro/windwalker" target="_blank">
                            <i class="fa fa-fw fa-github"></i>
                            <span class="menu-item-title">GitHub</span>
                        </a>
                    </li>

                                <div class="btn-group" style="margin-left: 15px">
                <button type="button" class="btn btn-default btn-raised dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    2.1 <i class="fa fa-caret-down"></i>
                </button>
                <ul class="dropdown-menu">
                    <li class="">
                        <a href="../../../documentation/3.x/mvc/model-database.html">3.x</a>
                    </li>

                    <li class="active">
                        <a href="../../../documentation/2.1/mvc/model-database.html">2.1</a>
                    </li>
                </ul>
            </div>
                        </ul>
            </div>
        </div>
    </div>

</nav>

        <section id="banner" class="container text-center">
            <div class="row">
                <div class="banner-content col-md-10">
                    <h1 class="banner-title">Model and Database</h1>
                </div>
            </div>
        </section>

    </section>

<div id="main-body" class="main main-raised main-raised-bottom">
        <section id="main-body" class="container main-block">
        <div class="row">
            <div class="col-md-3">
                    <div class="uk-width-medium-1-4 uk-container-center">
        <ul class="nav nav-stacked side-menu side-bar">
    
                
        <li class="nav-header">
        <h3 class="slab-font">Start</h3>
    </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/start/getting-started.html">Getting Started</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/start/routing-controller.html">Routing And Controller</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/start/package-system.html">Package System (Bundle)</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/start/config.html">Config &amp; Setting</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/start/request-input.html">Request and Input</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/start/ioc-container.html">IoC Container</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/start/service-provider.html">Service Provider</a>
            </li>
        
           <li class="nav-header">
        <h3 class="slab-font">MVC</h3>
    </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/mvc/use-controller.html">Use Controller</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/mvc/class-resolvers.html">Class Resolvers</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/mvc/view-templating.html">View and Templating</a>
            </li>
                    <li class="active">
                <a class="withripple" href="../../../documentation/2.1/mvc/model-database.html">Model and Database</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/mvc/view-model.html">ViewModel</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/mvc/uri-route-building.html">URI and Route Building</a>
            </li>
        
           <li class="nav-header">
        <h3 class="slab-font">Database</h3>
    </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/db/basic.html">Basic Usage</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/db/read-write.html">Read and Write</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/db/table-schema.html">Table and Schema</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/db/query-builder.html">Query Builder</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/db/active-record.html">ActiveRecord</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/db/datamapper.html">DataMapper</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/db/migration.html">Migration And Seeding</a>
            </li>
        
           <li class="nav-header">
        <h3 class="slab-font">Console</h3>
    </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/console/console-basic.html">Basic Usage</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/console/custom-commands.html">Custom Commands</a>
            </li>
        
           <li class="nav-header">
        <h3 class="slab-font">More</h3>
    </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/authentication.html">Authentication</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/caching.html">Caching</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/events.html">Events</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/data-object.html">Data Object</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/registry.html">Registry Object</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/widget-renderer.html">Widget and Renderer</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/form-builder.html">Form Builder</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/html-builder.html">HTML Builder</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/languages.html">Languages</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/pagination.html">Pagination</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/session.html">Session</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/datetime.html">DateTime</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/tests.html">Tests</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/validation.html">Validation</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/debugging.html">Debugging</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/error-handling.html">Error Handling</a>
            </li>
                    <li class="">
                <a class="withripple" href="../../../documentation/2.1/more/more-packages.html">More Packages</a>
            </li>
        
       </ul>
    </div>
            </div>

            <div class="col-md-9">
                <article class="article-content">
                    <h2>Use Model</h2>

<p>Model in Windwalker is not always means we have to operate database, it is a data provider and saver for sharing logic of 
controller that can prevent our controller too heavy.</p>

<p>This is an example of using Model:</p>

<pre><code class="php">use Windwalker\Core\Model\Model;

class MyModel extends Model
{
    public function getItem()
    {
        return file_get_contents(__DIR__ . '/data.md');
    }

    public function save($content)
    {
        file_put_contents(__DIR__ . '/data.md', $content);
    }
}
</code></pre>

<pre><code class="php">// In controller
$model = new MyModel;

$item = $model-&gt;getItem();

// Do something...

$model-&gt;save($item);
</code></pre>

<h2>DatabaseModel</h2>

<p>We can use <code>DatabaseModel</code> to operate Database, here is a <a href="http://goo.gl/hl5B">CRUD</a> example, <code>db</code> is preset in Model so we can get it quickly:</p>

<pre><code class="php">use Windwalker\Core\Model\DatabaseModel;

class FlowerModel extends DatabaseModel
{
    public function getItem($id)
    {
        $query = $this-&gt;db-&gt;getQuery(true);

        $query-&gt;select('*')
            -&gt;from('flowers')
            -&gt;where('id = ' . $id);

        return $this-&gt;db-&gt;setQuery($query)-&gt;loadOne();
    }

    public function save($data)
    {
        if ($data-&gt;id)
        {
            $this-&gt;db-&gt;getWriter()-&gt;updateOne('flowers', $data, 'id');
        }
        else
        {
            $this-&gt;db-&gt;getWriter()-&gt;insertOne('flowers', $data);
        }
    }

    public function delete($id)
    {
        $query = $this-&gt;db-&gt;getQuery(true);

        $query-&gt;delete('flowers')
            -&gt;where('id = ' . $id);

        return $this-&gt;db-&gt;setQuery($query)-&gt;execute();
    }
}
</code></pre>

<h2>Magic Method</h2>

<p>Model support a usage similar to NullObject pattern, if we call some method start with <code>get*()</code> or <code>load*()</code>, and this method not exists,
Model will not raise error but only return <code>null</code>.</p>

<pre><code class="php">use Windwalker\Core\Model\Model;

// This is default model, does not have any custom methods
$model = new Model;

// These 2 methods will only return null
$data = $model-&gt;getData();

$list = $model-&gt;loadList();
</code></pre>

<p>So, we can use default Model to provide empty data for some object but won't breaking our program.</p>

<h2>Model State</h2>

<p>Windwalker Model is stateful design, use state pattern can help ue create flexible data provider. 
For example, we can change this state to get different data.</p>

<pre><code class="php">class MyModel extends DatabaseModel
{
    // ...

    public function getUsers()
    {
        $published = $this-&gt;state-&gt;get('where.published', 1);

        $ordering  = $this-&gt;state-&gt;get('list.ordering', 'id');
        $direction = $this-&gt;state-&gt;get('list.direction', 'ASC');

        $sql = "SELECT * FROM users " .
            " WHERE published = " . $published .
            " ORDER BY " . $ordering . " " . $direction;

        try
        {
            return $this-&gt;db-&gt;setQuery($sql)-&gt;loadAll();
        }
        catch (\Exception $e)
        {
            $this-&gt;state-&gt;set('error', $e-&gt;getMessage());

            return false;
        }
    }
}

$model = new MyModel;

$state = $model-&gt;getState();

// Let's change model state
$state-&gt;set('where.published', 1);
$state-&gt;set('list.ordering', 'birth');
$state-&gt;set('list.direction', 'DESC');

$users = $model-&gt;getUsers();

if (!$users)
{
    $error = $state-&gt;get('error');
}
</code></pre>

<h5>Simple Way to Access State</h5>

<p>Using <code>get()</code> and <code>set()</code></p>

<pre><code class="php">// Same as getState()-&gt;get();
$model-&gt;get('where.author', 5);

// Same as getState()-&gt;set();
$model-&gt;set('list.ordering', 'RAND()');
</code></pre>

<h5>State ArrayAccess</h5>

<pre><code class="php">// Same as getState()-&gt;get();
$data = $model['list.ordering'];

// Same as getState()-&gt;set();
$model['list.ordering'] = 'created_time';
</code></pre>

<h2>Model Caching</h2>

<p>Windwalker Model provides runtime cache interface help us cache data in Model itself (This runtime cache only life in once
page load, will not exists in next page loading, and won't affected by global configuration).</p>

<p>This is an example to use cache in Model:</p>

<pre><code class="php">use Windwalker\Core\Model\Model;

class MyModel extends Model
{
    public function getData()
    {
        if ($this-&gt;cache-&gt;exists('item.data'))
        {
            return $this-&gt;cache-&gt;get('item.data');
        }

        $data = file_get_contents(__DIR__ . '/data.md');

        $this-&gt;cache-&gt;set('item.data', $data);

        return $data;
    }
}
</code></pre>

<h3>Generate Cache id When State Changed</h3>

<p>Model state is dynamic, so if we change state, the cache key should be refresh that we can make sure we get same data when state is same,
but get new data if state is changed.</p>

<pre><code class="php">public function getData()
{
    // Will generate a id look like: d967f4557f17dd542ece0f8a7b57b4f697c9b189
    $id = $this-&gt;getCacheId('item.data');

    if ($this-&gt;cache-&gt;exists($id))
    {
        return $this-&gt;cache-&gt;get($id);
    }

    $data = file_get_contents(__DIR__ . '/' . $this-&gt;state-&gt;get('file.name'));

    $this-&gt;cache-&gt;set($id, $data);

    return $data;
}
</code></pre>

<h3>Custom Cache id Rule</h3>

<p>If you trace <code>getCacheId()</code> at the parent, you will see:</p>

<pre><code class="php">public function getCacheId($id = null)
{
    $id = $id . json_encode($this-&gt;state-&gt;toArray());

    return sha1($id);
}
</code></pre>

<p>So override cache id rule is very easy, we can add some custom elements to hash:</p>

<pre><code class="php">public function getCacheId($id = null)
{
    $id .= json_encode($this-&gt;get('query.filter'));
    $id .= json_encode($this-&gt;get('query.search'));
    $id .= json_encode($this-&gt;get('query.where'));
    $id .= json_encode($this-&gt;get('query.having'));
    $id .= json_encode($this-&gt;get('query.ordering'));
    $id .= json_encode($this-&gt;get('query.direction'));
    $id .= json_encode($this-&gt;get('query.limit'));
    $id .= json_encode($this-&gt;get('query.start'));

    return sha1($id);
}
</code></pre>

<h3>Use Callback</h3>

<p>There is a simple way to quickly use cache, <code>fetch()</code> will auto check the cache exists or not and execute the callback to get data:</p>

<pre><code class="php">public function getData()
{
    $callback = function()
    {
        return file_get_contents(__DIR__ . '/' . $this-&gt;state-&gt;get('file.name'));
    };

    return $this-&gt;fetch('item.data', $callback);
}
</code></pre>

                        <hr />

    <p class="text-center inner-top-sm">
        If you found a typo or error, please help us <a target="_blank" href="https://github.com/ventoviro/ventoviro.github.io/tree/master/.vaseman/entries/documentation/2.1/mvc/model-database.md">improve</a> this document.
    </p>
                </article>
            </div>
        </div>
    </section>
</div>

<section id="footer" class="black-block inner-md text-center">

    <div class="container inner-top-md">
        
        <p>
            <a href="https://github.com/ventoviro/windwalker" class="btn" target="_blank">
                <i class="fa fa-github"></i>
                GitHub
            </a>

            <a href="http://natika.windwalker.io" class="btn" target="_blank">
                <i class="fa fa-comments"></i>
                Forum
            </a>

            <a href="http://windwalker.io/api-site/" class="btn" target="_blank">
                <i class="fa fa-code"></i>
                API
            </a>
        </p>

        <p class="outer-top-xs">
            <a href="#header" class="text-center footer-logo">
                <img class="img-invert" width="250" src="../../../media/images/logo/windwalker-logo.png" alt="Logo" style="">
            </a>
        </p>

        <p class="lead outer-top-xs">
            Copyright Â© 2016 Windwalker. All Rights Reserved.
        </p>
    </div>

</section>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-48372917-6', 'auto');
    ga('send', 'pageview');

</script>

</body>
</html>
